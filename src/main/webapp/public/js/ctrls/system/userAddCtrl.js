// Generated by CoffeeScript 1.10.0
define(['can/control', 'can', 'Auth', 'base', 'reqwest', 'bootbox', 'localStorage', 'select2cn'], function(Ctrl, can, Auth, base, reqwest, bootbox, localStorage) {
  return Ctrl.extend({
    init: function(el, data) {
      var addPageData, isNew, k, tmpUser, v;
      if (!can.base) {
        new base('', data);
      }
      addPageData = new can.Map({
        pageType: '新增'
      });
      this.element.html(can.view('../public/view/home/system/userAdd.html', addPageData));
      isNew = window.location.hash.endsWith('userAdd');
      if (!isNew) {
        addPageData.attr('pageType', '修改');
        tmpUser = localStorage.get('tmpUserInfo');
        if (tmpUser) {
          for (k in tmpUser) {
            v = tmpUser[k];
            if (!_.isObject(v)) {
              addPageData.attr(k, v);
            }
          }
        }
      }

      /**
       * 16-6-20 用户上级主管下拉框
       */
      reqwest(Auth.apiHost + "user/all?_=" + (Date.now())).then(function(data) {
        var leader;
        data = _.map(data, function(d) {
          return {
            id: d.id,
            text: d.username || d.loginid
          };
        });
        data.unshift({
          id: 'unselected',
          text: '请选择'
        });
        if (leader = tmpUser != null ? tmpUser.leader : void 0) {
          _.each(data, function(l) {
            if (l.id === leader.id) {
              return l.selected = true;
            }
          });
        }
        return $('#leader').select2({
          language: 'zh-CN',
          theme: 'bootstrap',
          data: data
        });
      });
      reqwest(Auth.apiHost + "dict/cities?_=" + (Date.now())).then(function(data) {
        var city;
        if (city = tmpUser != null ? tmpUser.city : void 0) {
          _.each(data, function(c) {
            if (c.id === city.id) {
              return c.selected = true;
            }
          });
        }
        $('#city').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: data
        });
        if (tmpUser && !(tmpUser != null ? tmpUser.city : void 0)) {
          return $('#city').val(null).change();
        }
      });
      reqwest(Auth.apiHost + "user/role/all").then(function(data) {
        var roleList, roles;
        roleList = _.map(data, function(role) {
          return {
            id: role.id,
            text: role.name
          };
        });
        if (roles = tmpUser != null ? tmpUser.roleList : void 0) {
          _.each(roleList, function(role0) {
            return _.each(roles, function(role1) {
              if (role0.id === role1.id) {
                return role0.selected = true;
              }
            });
          });
        }
        return $('#roles').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: roleList,
          multiple: true,
          tokenSeparators: [',', ' ']
        });
      });
      return $('#operates button').unbind('click').bind('click', function() {
        var ref, ref1, roles, user;
        switch ($(this).data('action')) {
          case 'save':
            user = {};
            ref = addPageData.attr();
            for (k in ref) {
              v = ref[k];
              if (k !== 'pageType' && !_.isObject(v)) {
                user[k] = v;
              }
            }
            user.id = Number(user.id);

            /**
             * 16-6-20 用户上级主管
             */
            user.leader = {
              id: ($('#leader').val() === 'unselected' ? null : $('#leader').val())
            };
            user.city = {
              id: $('#city').val()
            };
            if ($('#roles').val()) {
              user.roleList = _.map($('#roles').val(), function(role) {
                return {
                  id: role
                };
              });
            }
            return reqwest({
              url: Auth.apiHost + "user/save",
              method: "post",
              contentType: 'application/json',
              type: 'html',
              data: JSON.stringify(user)
            }).then(function() {
              localStorage.remove('tmpUserInfo');
              return bootbox.alert("用户" + (isNew ? '新增' : '修改') + "成功！", function() {
                return window.location.hash = "home/system/userView";
              });
            }).fail(function(err) {
              return bootbox.alert("用户" + (isNew ? '新增' : '修改') + "失败！" + err.responseText);
            });
          case 'refresh':
            if (tmpUser) {
              for (k in tmpUser) {
                v = tmpUser[k];
                if (!_.isObject(v)) {
                  addPageData.attr(k, v);
                }
              }
              if (tmpUser.city) {
                $('#city').val(tmpUser.city.id).trigger('change');
              }
              if (tmpUser.roleList) {
                roles = _.map(tmpUser.roleList, function(role) {
                  return role.id;
                });
                return $('#roles').val(roles).trigger('change');
              }
            } else {
              ref1 = addPageData.attr();
              for (k in ref1) {
                v = ref1[k];
                if (k === 'pageType') {
                  continue;
                }
                if (typeof v === 'number') {
                  addPageData.attr(k, 0);
                }
                if (typeof v === 'string') {
                  addPageData.attr(k, '');
                }
              }
              $('#city').val(1).trigger('change');
              return $('#roles').val(null).trigger('change');
            }
            break;
          case 'cancel':
            return window.location.hash = "home/system/userView";
        }
      });
    }
  });
});

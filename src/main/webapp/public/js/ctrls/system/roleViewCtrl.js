// Generated by CoffeeScript 1.10.0
define(['can/control', 'can', 'Auth', 'base', 'reqwest', 'localStorage', 'bootbox', 'datatables.net', 'datatables.net-bs', 'datatables.net-responsive', 'datatables.net-responsive-bs'], function(Ctrl, can, Auth, base, reqwest, localStorage, bootbox) {
  return Ctrl.extend({
    init: function(el, data) {
      var table;
      if (!can.base) {
        new base('', data);
      }
      this.element.html(can.view('../public/view/home/system/roleView.html'));
      table = $('#roleTable').DataTable({
        paging: false,
        ajax: {
          url: Auth.apiHost + 'user/role/all',
          dataSrc: function(data) {
            return data;
          }
        },
        columns: [
          {
            data: 'id',
            visible: false
          }, {
            data: 'name'
          }, {
            data: 'menuList',
            render: function(data) {
              var k, menus, v;
              menus = '';
              for (k in data) {
                v = data[k];
                menus += v.name + ", ";
                if (k >= 10) {
                  menus = menus.substring(0, menus.length - 2) + '...';
                  break;
                }
              }
              return menus;
            }
          }
        ]
      });
      $('#roleTable tbody').on('click', 'tr', function() {
        var row;
        if ($(this).hasClass('info')) {
          $(this).removeClass('info');
          return $('#operates button:gt(0)').attr('disabled', 'disabled');
        } else {
          table.$('tr.info').removeClass('info');
          $(this).addClass('info');
          row = table.row(this).data();
          return $('#operates button[disabled]').removeAttr('disabled');
        }
      });
      return $('#operates button').unbind('click').bind('click', function() {
        var selRow;
        selRow = table.row('.info').data();
        switch ($(this).data('action')) {
          case 'create':
            return window.location.hash = 'home/system/roleAdd';
          case 'update':
            localStorage.set('tmpRoleInfo', selRow);
            return window.location.hash = "home/system/roleAdd/" + selRow.id;
          case 'delete':
            return reqwest({
              url: Auth.apiHost + "user/role/del/" + selRow.id,
              method: "delete",
              type: "html"
            }).then(function() {
              return table.row('.info').remove().draw();
            }).fail(function(err) {
              return bootbox.alert('角色删除失败！');
            });
        }
      });
    }
  });
});

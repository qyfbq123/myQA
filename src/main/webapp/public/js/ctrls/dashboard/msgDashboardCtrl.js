// Generated by CoffeeScript 1.10.0
define(['can/control', 'can', 'base', 'Auth', 'reqwest', '_'], function(Control, can, base, Auth, reqwest) {
  var pageData;
  pageData = new can.Map();
  return Control.extend({
    init: function(el, data) {
      var queryMsgPage;
      this.element.html(can.view('../public/view/home/dashboard/msgDashboard.html', pageData));
      queryMsgPage = function(callback) {
        var start;
        start = $('#page-wrapper .msgRow').length;
        return reqwest(Auth.apiHost + "msg/page?_=" + (Date.now()) + "&start=" + start).then(function(data) {
          _.each(data, function(e, i) {
            var msg;
            if (e.created) {
              e.created = new Date(e.created).toLocaleString();
            }
            if (e.date) {
              e.date = new Date(e.date).toLocaleDateString();
            }
            msg = can.view('../public/view/home/dashboard/msg.stache', e);
            return $('#page-wrapper').append(msg);
          });
          if (callback) {
            return callback(data);
          }
        });
      };
      queryMsgPage(function(data) {
        if (data.length === 0) {
          $('#noMsgShow').removeClass('hide');
        }
        if (data.length !== 20) {
          return $('#more').addClass('hide');
        } else {
          return $('#page-wrapper').append($('#more'));
        }
      });
      return $('#more').unbind('click').bind('click', function() {
        return queryMsgPage(function(data) {
          if (data.length !== 20) {
            return $('#more').addClass('hide');
          } else {
            return $('#page-wrapper').append($('#more'));
          }
        });
      });
    }
  });
});

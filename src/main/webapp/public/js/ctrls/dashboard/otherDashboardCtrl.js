// Generated by CoffeeScript 1.10.0
define(['can/control', 'can/view/mustache', 'base', 'Auth', 'reqwest', 'bootbox', 'pdfjs-dist/web/pdf_viewer', 'videojs', '_', 'datatables.net', 'datatables.net-bs', 'datatables.net-responsive', 'datatables.net-responsive-bs', 'select2cn', 'datepickercn', 'es6shim'], function(Control, can, base, Auth, reqwest, bootbox, pdfDist, videojs) {
  var PDFJS, pageData;
  pageData = new can.Map();
  PDFJS = pdfDist.PDFJS;
  return Control.extend({
    init: function(el, pdata) {
      var container, pdfViewer, table, videoPlayer;
      pageData.attr('userIsOnSite', Auth.userIsOnSite());
      pageData.attr('userIsContract', Auth.userIsContract());
      this.element.html(can.view("../public/view/home/dashboard/otherDashboard.html", pageData));
      $('.input-group.date input').datepicker({
        language: 'zh-CN',
        todayBtn: true,
        autoclose: true
      });
      $('#category').select2({
        language: 'zh-CN',
        theme: "bootstrap",
        placeholder: '请选择'
      });
      $('#category').change(function() {
        var $group;
        if ($(this).val() === 'rule') {
          $('#docType').closest('.form-group').addClass('hide');
          $('#docProperty').closest('.form-group').addClass('hide');
          $group = $('#function').closest('.form-group');
          $group.removeClass('hide');
          if (!$group.data('done')) {
            reqwest(Auth.apiHost + "dict/functions?_=" + (Date.now())).then(function(data) {
              var functions;
              functions = _.map(data, function(e) {
                return {
                  id: e.text,
                  text: e.text
                };
              });
              return $('#function').select2({
                language: 'zh-CN',
                theme: "bootstrap",
                placeholder: '请选择',
                data: functions
              });
            }).fail(function(err) {
              return bootbox.alert('获取发布职能失败！');
            });
            return $group.data('done', true);
          }
        } else if ($(this).val() === 'doc') {
          $('#function').closest('.form-group').addClass('hide');
          $group = $('#docType').closest('.form-group');
          $group.removeClass('hide');
          if (!$group.data('done')) {
            reqwest(Auth.apiHost + "dict/docTypes?_=" + (Date.now())).then(function(data) {
              var types;
              types = _.map(data, function(e) {
                return {
                  id: e.text,
                  text: e.text
                };
              });
              return $('#docType').select2({
                language: 'zh-CN',
                theme: "bootstrap",
                placeholder: '请选择',
                data: types
              });
            }).fail(function(err) {
              return bootbox.alert('获取文档类型失败！');
            });
            $group.data('done', true);
          }
          $group = $('#docProperty').closest('.form-group');
          $group.removeClass('hide');
          if (!$group.data('done')) {
            $('#docProperty').select2({
              language: 'zh-CN',
              theme: "bootstrap",
              placeholder: '请选择'
            });
            return $group.data('done', true);
          }
        }
      });
      table = $('#otherList').DataTable({
        paging: true,
        bFilter: false,
        processing: true,
        serverSide: true,
        ordering: false,
        "order": [],
        ajax: {
          url: Auth.apiHost + "doc/other/page?_=" + (Date.now()),
          data: function(d) {
            var k, search, v;
            search = $('#searchForm').serializeObject();
            for (k in search) {
              v = search[k];
              if (!v) {
                delete search[k];
              }
            }
            _.extend(d, search);
            d.dateBegin = $('#dateBegin').datepicker('getDate') || void 0;
            d.dateEnd = $('#dateEnd').datepicker('getDate') || void 0;
            return d;
          }
        },
        columns: [
          {
            data: 'category',
            render: function(data) {
              if (data === 'rule') {
                return '细则';
              } else {
                return '文档';
              }
            }
          }, {
            data: 'function'
          }, {
            data: 'docType'
          }, {
            data: 'docProperty'
          }, {
            data: 'content'
          }, {
            data: 'importance'
          }, {
            data: 'creator'
          }, {
            data: 'date',
            render: function(data) {
              if (data) {
                return new Date(data).toLocaleDateString();
              } else {
                return '';
              }
            }
          }, {
            data: 'id',
            responsivePriority: 2,
            render: function(data, d, row) {
              var $btn;
              $btn = $("<a href='#!home/administration/" + row.category + "/" + data + "' class='btn btn-danger btn-xs' type='button'/>").text('详情');
              return $btn[0].outerHTML;
            }
          }, {
            data: 'id',
            responsivePriority: 2,
            render: function(data, d, row) {
              var $btn;
              $btn = $("<button class='btn btn-danger btn-xs' type='button'/>").text('删除');
              return $btn[0].outerHTML;
            }
          }, {
            data: 'file',
            responsivePriority: 2,
            render: function(data, d, row) {
              var $href;
              if (data) {
                if (data.filename.endsWith('.pdf')) {
                  $href = $("<a href='#' data-src='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-toggle='modal' data-target='#largeModal'/>").text("" + data.filename);
                } else if (/\.avi|\.rmvb|\.rm|\.asf|\.divx|\.mpg|\.mpeg|\.wmv|\.mp4|\.mkv/.test(data.filename)) {
                  $href = $("<a href='#' data-src='" + Auth.apiHost + "doc/video/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-downloadurl='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-toggle='modal' data-target='#normalModal'/>").text("" + data.filename);
                } else {
                  $href = $("<a href='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "'/>").text("" + data.filename);
                }
                return $href[0].outerHTML;
              }
            }
          }
        ]
      });
      $('#otherList tbody').on('click', 'button', function(e) {
        var $row, doc;
        $row = $(this).closest('tr');
        doc = table.row($row).data();
        return reqwest({
          url: Auth.apiHost + "doc/other/" + doc.id,
          method: "delete",
          type: 'html'
        }).then(function() {
          return table.ajax.reload();
        }).fail(function() {
          return bootbox.alert('删除失败！');
        });
      });
      $('#searchForm button').unbind('click').bind('click', function(e) {
        return table.ajax.reload();
      });
      videoPlayer = videojs($('video', $('#normalModal'))[0], {});
      container = document.getElementById('viewerContainer');
      pdfViewer = new PDFJS.PDFViewer({
        container: container
      });
      container.addEventListener('pagesinit', function() {
        return pdfViewer.currentScaleValue = 'page-width';
      });
      $('.modal').on('show.bs.modal', function(event) {
        var $ahref, modal, url;
        $ahref = $(event.relatedTarget);
        url = $ahref.data('src');
        if (url !== $('.download-btn', modal).attr('href')) {
          modal = $($ahref.data('target'));
          $('.modal-title', modal).text($ahref.text());
          $('.download-btn', modal).attr('href', $ahref.data('downloadurl') || url);
          if ($ahref.text().endsWith('.pdf')) {
            return PDFJS.getDocument(url).then(function(pdfDocument) {
              return pdfViewer.setDocument(pdfDocument);
            });
          } else {
            if (url !== videoPlayer.currentSrc()) {
              return videoPlayer.src(url);
            }
          }
        }
      });
      $('#normalModal').on('shown.bs.modal', function(event) {
        var modalBodyWidth;
        modalBodyWidth = $('#normalModal .modal-body').width();
        videoPlayer.dimensions(modalBodyWidth, modalBodyWidth / 640 * 360);
        return videoPlayer.play();
      });
      return $('#normalModal').on('hide.bs.modal', function(event) {
        return videoPlayer.pause();
      });
    }
  });
});

// Generated by CoffeeScript 1.10.0
define(['can/control', 'can', 'Auth', 'base', 'reqwest', 'bootbox', 'localStorage', 'select2cn', 'datepickercn', 'uploader'], function(Ctrl, can, Auth, base, reqwest, bootbox, localStorage) {
  return Ctrl.extend({
    init: function(el, data) {
      var questionInfo;
      if (!can.base) {
        new base('', data);
      }
      questionInfo = new can.Map({
        category: data.category,
        title: data.id ? "详情" : data.category + "管理 / 新增"
      });
      this.element.html(can.view('../public/view/home/question/questionAdd.html', questionInfo));
      $('.input-group.date input').datepicker({
        language: 'zh-CN',
        startDate: "0d",
        todayBtn: true,
        autoclose: true
      });
      reqwest(Auth.apiHost + "dict/projects?_=" + (Date.now())).then(function(data) {
        data = _.map(data, function(d) {
          return {
            id: d.text,
            text: d.text
          };
        });
        return $('#project').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: data
        });
      });
      reqwest(Auth.apiHost + "dict/types/ms?_=" + (Date.now())).then(function(data) {
        data = _.map(data, function(d) {
          return {
            id: d.text,
            text: d.text
          };
        });
        return $('#type').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: data
        });
      });
      reqwest(Auth.apiHost + "user/group/all?_=" + (Date.now())).then(function(data) {
        var groups;
        groups = _.map(data, function(group) {
          return {
            id: group.id,
            text: group.name
          };
        });
        return $('#group').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: groups
        });
      });
      reqwest(Auth.apiHost + "user/role/handlers?_=" + (Date.now())).then(function(data) {

        /**
         * 16-6-22 用户按地域区分下
         */
        data = _.groupBy(data, function(user) {
          return user.city && user.city.name;
        });
        data = _.map(data, function(users, city) {
          var children;
          children = _.map(users, function(user) {
            return {
              id: user.id,
              text: user.username || user.loginid
            };
          });
          return {
            text: (city === 'null' ? '其他' : city),
            children: children
          };
        });
        return $('#handler').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: data
        });
      });
      reqwest(Auth.apiHost + "dict/cities?_=" + (Date.now())).then(function(data) {
        return $('#city').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          data: data
        });
      });
      if (data.id) {
        $('#submitBtn').closest('.form-group').addClass('hide');
        reqwest(Auth.apiHost + "/question/" + data.id).then(function(data) {
          questionInfo.attr('title', "编号：" + data.number);
          $('#project, #type').each(function(i, e) {
            if (!$(this).attr('name')) {
              return;
            }
            return $(this).val(data[$(this).attr('name')]).change();
          });
          $('#group, #city, #handler').each(function(i, e) {
            if (!$(this).attr('name')) {
              return;
            }
            return $(this).val(data[$(this).attr('name')].id).change();
          });
          $('form input').each(function(i, e) {
            var d;
            if (!$(this).attr('name')) {
              return;
            }
            d = data[$(this).attr('name')];
            if ($(this).parent().hasClass('date')) {
              return $(this).datepicker('setDate', new Date(d));
            } else {
              return $(this).val(d);
            }
          });
          return $('form textarea').each(function(i, e) {
            if (!$(this).attr('name')) {
              return;
            }
            return $(this).val(data[$(this).attr('name')]);
          });
        }).fail(function() {
          return bootbox.alert('获取问题详细信息失败！');
        });
      }
      $('#resetBtn').unbind('click').bind('click', function(e) {
        var k, ref, v;
        ref = questionInfo.attr();
        for (k in ref) {
          v = ref[k];
          if (k !== 'category' && k !== 'title') {
            questionInfo.attr(k, '');
          }
        }
        $('#startdate').datepicker('setDate', null);
        return $('#promisedate').datepicker('setDate', null);
      });
      return $('#submitBtn').unbind('click').bind('click', function(e) {
        var k, question, ref, v;
        question = {
          project: $('#project').val(),
          type: $('#type').val(),
          group: {
            id: $('#group').val()
          },
          city: {
            id: $('#city').val()
          },
          handler: {
            id: $('#handler').val()
          },
          startdate: $('#startdate').datepicker('getDate'),
          promisedate: $('#promisedate').datepicker('getDate')
        };
        ref = questionInfo.attr();
        for (k in ref) {
          v = ref[k];
          if (k !== 'title') {
            question[k] = v;
          }
        }
        return reqwest({
          url: Auth.apiHost + "question/create",
          method: 'post',
          data: JSON.stringify(question),
          contentType: "application/json",
          type: 'html'
        }).then(function() {
          return bootbox.alert('新增成功！', function() {
            return $('#resetBtn').trigger('click');
          });
        }).fail(function(err) {
          return bootbox.alert("新增失败！" + err.responseText);
        });
      });
    }
  });
});

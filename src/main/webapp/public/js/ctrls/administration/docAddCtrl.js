// Generated by CoffeeScript 1.10.0
define(['can/control', 'can', 'Auth', 'base', 'reqwest', 'bootbox', 'localStorage', 'pdfjs-dist/build/pdf', 'videojs', 'select2cn', 'datepickercn', 'datatables.net', 'datatables.net-bs', 'es6shim', 'jqueryFileupload'], function(Ctrl, can, Auth, base, reqwest, bootbox, localStorage, pdfDist, videojs) {
  return Ctrl.extend({
    init: function(el, data) {
      var DEFAULT_SCALE, PDFJS, docInfo, isNew, ref, renderPdf, table, videoPlayer;
      if (!can.base) {
        new base('', data);
      }
      PDFJS = pdfDist.PDFJS;
      docInfo = new can.Map();
      this.element.html(can.view('../public/view/home/administration/docAdd.html', docInfo));
      isNew = data.id ? false : true;
      reqwest(Auth.apiHost + "dict/docTypes?_=" + (Date.now())).then(function(data) {
        var _val, types;
        types = _.map(data, function(e) {
          return {
            id: e.text,
            text: e.text
          };
        });
        _val = $('#docType').val();
        $('#docType').select2({
          language: 'zh-CN',
          theme: "bootstrap",
          placeholder: '请选择',
          data: types
        });
        if (_val) {
          return $('#docType').val(_val).change;
        }
      }).fail(function(err) {
        return bootbox.alert('获取文档类型失败！');
      });
      $('#docProperty').select2({
        language: 'zh-CN',
        theme: "bootstrap",
        placeholder: '请选择'
      });
      $('.input-group.date input').datepicker({
        language: 'zh-CN',
        todayBtn: true,
        autoclose: true
      });
      $('#filePicker').fileupload({
        url: Auth.apiHost + "doc/file/upload",
        dataType: 'json',
        send: function() {
          return $('#filePicker').prop('disabled', true);
        },
        done: function(e, data) {
          table.row.add(data.result).draw(false);
          $('#fileRow').removeClass('hide');
          return $('#filePicker').closest('span').addClass('hide');
        },
        fail: function() {
          return bootbox.alert('文档上传失败');
        },
        always: function() {
          return $('#filePicker').prop('disabled', false);
        }
      }).prop('disabled', !$.support.fileInput).parent().addClass((ref = $.support.fileInput) != null ? ref : {
        undefined: 'disabled'
      });
      table = $('#fileList').DataTable({
        paging: false,
        ordering: false,
        searching: false,
        info: false,
        columns: [
          {
            data: 'id',
            visible: false
          }, {
            data: 'filename',
            render: function(filename, d, data) {
              var $href;
              if (data) {
                if (data.filename.endsWith('.pdf')) {
                  $href = $("<a href='#' data-src='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-toggle='modal' data-target='#largeModal'/>").text("" + data.filename);
                } else if (/\.avi|\.rmvb|\.rm|\.asf|\.divx|\.mpg|\.mpeg|\.wmv|\.mp4|\.mkv/.test(data.filename)) {
                  $href = $("<a href='#' data-src='" + Auth.apiHost + "doc/video/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-downloadurl='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "' data-toggle='modal' data-target='#normalModal'/>").text("" + data.filename);
                } else {
                  $href = $("<a href='" + Auth.apiHost + "doc/file/" + data.id + "/" + (encodeURIComponent(data.filename)) + "'/>").text("" + data.filename);
                }
                return $href[0].outerHTML;
              }
            }
          }, {
            data: 'size'
          }, {
            data: 'uploader',
            render: function(data, d, row) {
              return $("<button data-id='" + row.id + "'/>").addClass('btn btn-sm btn-danger').data('id', row.id).text('删除')[0].outerHTML;
            }
          }
        ]
      });
      $('#fileList tbody').on('click', 'button.btn-danger', function() {
        table.row($(this).parents('tr')).remove().draw();
        if (table.rows().data().length <= 0) {
          $('#fileRow').addClass('hide');
          $('#filePicker').closest('span').removeClass('hide');
        }
        return reqwest({
          url: Auth.apiHost + "doc/file/" + ($(this).data('id')),
          method: 'delete',
          type: 'html'
        }).then(function() {});
      });
      $('#saveBtn').click(function() {
        var doc, fileList;
        doc = docInfo.attr();
        doc.category = 'doc';
        if (isNew) {
          fileList = table.rows().data();
          if (fileList.length > 0) {
            doc.file = {
              id: fileList[0].id
            };
          } else {
            bootbox.alert('必须上传文档！');
            return;
          }
        }
        $('select').each(function(i, e) {
          if (!$(this).attr('name')) {
            return;
          }
          if (!$(this).val()) {
            return delete doc[$(this).attr('name')];
          }
        });
        $('.input-group.date input').each(function(e, i) {
          return doc[$(this).attr('name')] = $(this).datepicker('getDate');
        });
        if (isNew) {
          return reqwest({
            url: Auth.apiHost + "doc/createOther",
            method: 'post',
            data: JSON.stringify(doc),
            contentType: "application/json",
            type: 'html'
          }).then(function() {
            return bootbox.alert('保存成功！', function() {
              var k, ref1, v;
              ref1 = docInfo.attr();
              for (k in ref1) {
                v = ref1[k];
                docInfo.attr(k, '');
              }
              $('.input-group.date input').datepicker('setDate', null);
              table.clear().draw();
              $('#fileRow').addClass('hide');
              return $('#filePicker').closest('span').removeClass('hide');
            });
          }).fail(function(err) {
            return bootbox.alert("保存失败！" + err.responseText);
          });
        } else {
          return reqwest({
            url: Auth.apiHost + "doc/updateOther",
            method: 'put',
            data: JSON.stringify(doc),
            contentType: "application/json",
            type: 'html'
          }).then(function() {
            return bootbox.alert('保存成功！', function() {
              return history.go(-1);
            });
          }).fail(function(err) {
            return bootbox.alert("保存失败！" + err.responseText);
          });
        }
      });
      if (data.id) {
        reqwest(Auth.apiHost + "doc/other/" + data.id + "?_=" + (Date.now())).then(function(data) {
          docInfo.attr(data);
          $('select').each(function() {
            if (!$(this).attr('name')) {
              return;
            }
            return $(this).val(data[$(this).attr('name')] || '').change();
          });
          $('.input-group.date input').each(function() {
            var d;
            if (!$(this).attr('name')) {
              return;
            }
            d = data[$(this).attr('name')];
            if (d) {
              return $(this).datepicker('setDate', new Date(d));
            }
          });
          $('#filePicker').closest('span').addClass('hide');
          if (data.file) {
            table.row.add(data.file).draw(false);
            table.column(3).visible(false);
            return $('#fileRow').removeClass('hide');
          }
        });
      }
      DEFAULT_SCALE = 1.5;
      renderPdf = function(pdf, svgLib, modalBody) {
        var j, modalFooter, promise, results, sumPages;
        modalFooter = $(modalBody).next('.modal-footer');
        $('.incomplete-warn', modalFooter).addClass('hide');
        promise = $.Deferred().resolve();
        sumPages = pdf.numPages;
        if (sumPages > 20) {
          sumPages = 20;
          $('.incomplete-warn', modalFooter).removeClass('hide');
          $('.pages-number', modalFooter).text(pdf.numPages);
        }
        return _.each((function() {
          results = [];
          for (var j = 1; 1 <= sumPages ? j <= sumPages : j >= sumPages; 1 <= sumPages ? j++ : j--){ results.push(j); }
          return results;
        }).apply(this), function(e) {
          return promise = promise.then((function(pageNum) {
            return pdf.getPage(pageNum).then(function(page) {
              var container, viewport;
              viewport = page.getViewport(DEFAULT_SCALE);
              container = document.createElement('div');
              container.id = 'pageContainer' + pageNum;
              container.className = 'pageContainer';
              container.style.width = viewport.width + 'px';
              container.style.height = viewport.height + 'px';
              modalBody.appendChild(container);
              return page.getOperatorList().then(function(opList) {
                var svgGfx;
                svgGfx = new svgLib.SVGGraphics(page.commonObjs, page.objs);
                return svgGfx.getSVG(opList, viewport).then(function(svg) {
                  return container.appendChild(svg);
                });
              });
            });
          }).bind(null, e));
        });
      };
      videoPlayer = videojs($('video', $('#normalModal'))[0], {});
      $('.modal').on('show.bs.modal', function(event) {
        var $ahref, modal, url;
        $ahref = $(event.relatedTarget);
        url = $ahref.data('src');
        if (url !== $('.download-btn', modal).attr('href')) {
          $('#largeModal .pageContainer').remove();
          modal = $($ahref.data('target'));
          $('.modal-title', modal).text($ahref.text());
          $('.download-btn', modal).attr('href', $ahref.data('downloadurl') || url);
          if ($ahref.text().endsWith('.pdf')) {
            return PDFJS.getDocument(url).then(function(doc) {
              return renderPdf(doc, PDFJS, $('.modal-body', modal)[0]);
            });
          } else {
            if (url !== videoPlayer.currentSrc()) {
              return videoPlayer.src(url);
            }
          }
        }
      });
      $('#normalModal').on('shown.bs.modal', function(event) {
        var modalBodyWidth;
        modalBodyWidth = $('#normalModal .modal-body').width();
        videoPlayer.dimensions(modalBodyWidth, modalBodyWidth / 640 * 360);
        return videoPlayer.play();
      });
      return $('#normalModal').on('hide.bs.modal', function(event) {
        return videoPlayer.pause();
      });
    }
  });
});
